var monthPicker={_conf:{startYear:1970,endYear:new Date().getFullYear(),cols:4,rows:3,container:"gri_monthPicker_wrapper",calendar:"gri_monthPicker_panel",dataTable:"gri_monthPicker_table",containerCss:"calendar cf",selectCss:"current",contentCss:"calendar_cont cf",tableCss:"calendar-month",disabledCss:"dis",input:{},id:"month_picker",trigger:"month_trigger",callback:function(obj){return true},autoCommit:false,returnMonth:false,defaultMonth:"",lastMonth:false,period:false,start_month:"",end_month:"",all_month_valid:false,defaultText:" 至 "},assemble:{"year":new Date().getFullYear(),"month":new Date().getMonth()+1},create:function(id,conf){var that=this;that._conf.id=id;that._conf=$.extend(true,that._conf,conf);$("#"+id).length>0&&function(){$("#"+id).bind("click",function(){that.show(that.util.$(id))})}();$("#"+that._conf.trigger).length>0&&function(){$("#"+that._conf.trigger).bind("click",function(){that.show(that.util.$(id))})}();if(that._conf.period&&that._conf.start_month!=""&&that._conf.end_month!=""){$("#"+id).html(that._conf.start_month+that._conf.defaultText+that._conf.end_month);that._conf.autoCommit&&that._conf.callback({startDate:that._conf.start_month+"-01",endDate:that._conf.end_month+"-31"})}else{this._conf.lastMonth&&(this.assemble.month=new Date().getMonth());""!==this._conf.defaultMonth&&(this.assemble={"year":this._conf.defaultMonth.substr(0,4),"month":this._conf.defaultMonth.substr(4)*1});var def=this.util.format(this.assemble);$("#"+id).html(def.year+"-"+def.month);that._conf.autoCommit&&that._conf.callback(that.convertToDate(this.util.format(this.assemble)))}$(document).bind("click",function(evt){that.cancel(evt)})},getCurrentShowDate:function(){var that=this,str="";if($("#"+that._conf.id).length>0){str=$("#"+that._conf.id).html();return{"year":str.split("-")[0],"month":str.split("-")[1]}}},convertToDate:function(obj){if(this._conf.returnMonth){return{"start_date":obj.year+"-"+obj.month+"-01","end_date":obj.year+"-"+obj.month+"-31"}}else{return obj.year+"-"+obj.month}},show:function(ref){this._conf.input=ref;if(this.util.$(this._conf.container)){var pos=$("#"+this._conf.id).offset();var offsetHeight=$("#"+this._conf.id).attr("offsetHeight");this.util.$(this._conf.container).style.display="block";this.util.$(this._conf.container).style.top=pos.top+(offsetHeight?offsetHeight-1:32)+"px";return false}var div=this.util.creatEle("div");div.setAttribute("id",this._conf.container);$(div).addClass(this._conf.containerCss);div.style.zIndex="9999";var pos=$("#"+this._conf.id).offset();var offsetHeight=$("#"+this._conf.id).attr("offsetHeight");div.style.top=pos.top+(offsetHeight?offsetHeight-1:32)+"px";document.body.appendChild(div);var contentDiv=this.util.creatEle("div");contentDiv.id=this._conf.calendar;$(contentDiv).addClass(this._conf.contentCss);var ctrl=[];ctrl.push('<i class="i_pre" style="z-index:1" id="gri_preYear"></i>');ctrl.push('<i class="i_next" style="z-index:1" id="gri_nextYear"></i>');$(contentDiv).append(ctrl.join(""));div.appendChild(contentDiv);div.style.display="block";this.init()},init:function(){var that=this;var ctrl=panel=[];var table=this.util.creatEle("table");$(table).addClass(this._conf.tableCss);var cap=document.createElement("caption");var sp=document.createElement("span");sp.id="gri_year";$(sp).append(this._conf.endYear+"年");$(cap).append(sp);$(table).append(cap);var tbody=this.util.creatEle("tbody");var tr=this.util.creatEle("tr");var td=this.util.creatEle("td");tbody.setAttribute("id",this._conf.dataTable);table.appendChild(tbody);this._conf.calendar?this.util.$(this._conf.calendar).appendChild(table):document.body.appendChild(table);this.construct();ctrl=[];$("#gri_preYear").click(function(){that.preYear(that.reset)});$("#gri_nextYear").click(function(){that.nextYear(that.reset)});this.reset(this);return table},construct:function(){that=this;$("#"+this._conf.dataTable).html("");var months={data:{1:[1,2,3,4],2:[5,6,7,8],3:[9,10,11,12]},typical:{1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十",11:"十一",12:"十二"},special:{}};for(var p in months.data){var tr=this.util.creatEle("tr");for(var i=0;i<months.data[p].length;i++){var td=this.util.creatEle("td");td.innerHTML=months.typical[months.data[p][i]]+"月";td.setAttribute("id","gri_month"+months.data[p][i]);var method=this.addCss;if(!this._conf.all_month_valid&&this.assemble.year==this.util.getCurrentDate().year&&months.data[p][i]>this.util.getCurrentDate().month){$(td).addClass(this._conf.disabledCss)}else{if(this._conf.period){method=this.hdlPeriod}if(window.attachEvent){td.attachEvent("onclick",method)}else{td.addEventListener("click",method,false)}}tr.appendChild(td)}$("#"+this._conf.dataTable).append(tr)}},preYear:function(fn){--this.assemble.year;this.util.$("gri_year").innerHTML=this.assemble.year+"年";fn&&fn(this)},nextYear:function(fn){++this.assemble.year;this.util.$("gri_year").innerHTML=this.assemble.year+"年";fn&&fn(this)},hdlPeriod:function(evt){var evt=window.event||evt,target=evt.srcElement||evt.target;var select_month=(/^gri_month(\d+)/).test(target.getAttribute("id"))&&(/^gri_month(\d+)/).exec(target.getAttribute("id"))[1];var start=end={};that.removeCss();(monthPicker.Params.current==""||monthPicker.Params.current==monthPicker.Constant.END_MONTH)?(monthPicker.Params.current=monthPicker.Constant.START_MONTH):(monthPicker.Params.current=monthPicker.Constant.END_MONTH);if(monthPicker.Params.current==monthPicker.Constant.START_MONTH){$(target).addClass(that._conf.selectCss);monthPicker.Params.start_month=select_month;monthPicker.Params.start_year=that.assemble.year}else{monthPicker.Params.end_month=select_month;monthPicker.Params.end_year=that.assemble.year;var ret=that.periodCss();var start=ret.start,end=ret.end;that._conf.input.innerHTML=[start.year,start.month].join("-")+that._conf.defaultText+[end.year,end.month].join("-");that._conf.callback({startDate:start.year+"-"+start.month+"-01",endDate:end.year+"-"+end.month+"-31"});that.util.$(that._conf.container).style.display="none"}},addCss:function(evt){that.removeCss();var evt=window.event||evt,target=evt.srcElement||evt.target;$(target).addClass(that._conf.selectCss);that.assemble.month=(/^gri_month(\d+)/).test(target.getAttribute("id"))&&(/^gri_month(\d+)/).exec(target.getAttribute("id"))[1];that.submit()},removeCss:function(){var reg=/^gri_month(\d+)/;var cells=$("#gri_monthPicker_table").find("td");for(var o in cells){if(cells[o].id&&reg.test(cells[o].id)){$(cells[o]).removeClass(this._conf.selectCsss).removeClass(this._conf.disabledCss);if(!this._conf.all_month_valid&&this.assemble.year==this.util.getCurrentDate().year&&cells[o].id.match(reg)[1]>this.util.getCurrentDate().month){$(cells[o]).addClass(this._conf.disabledCss)}}}},periodCss:function(){var start=that.util.format({year:monthPicker.Params.start_year,month:monthPicker.Params.start_month});var end=that.util.format({year:monthPicker.Params.end_year,month:monthPicker.Params.end_month});if(new Date([start.year,start.month,"01"].join("-")).getTime()>new Date([end.year,end.month,"01"].join("-")).getTime()){var tmp=start;start=end;end=tmp}if(monthPicker.Params.start_year==monthPicker.Params.end_year){if(that.assemble.year==start.year||""==start.year){sm=Math.min(monthPicker.Params.end_month,monthPicker.Params.start_month);em=Math.max(monthPicker.Params.end_month,monthPicker.Params.start_month);for(var i=sm;i<=em;i++){$("#gri_month"+i).addClass(that._conf.selectCss)}}else{that.removeCss()}}else{if(that.assemble.year==start.year){for(var i=start.month*1;i<=12;i++){$("#gri_month"+i).addClass(that._conf.selectCss)}}else{if(that.assemble.year==end.year){for(var i=1;i<=end.month*1;i++){$("#gri_month"+i).addClass(that._conf.selectCss)}}else{that.removeCss()}}}return{"start":start,"end":end}},cancel:function(evt){var evt=window.event||evt,target=evt.srcElement||evt.target;!(target.id&&(target.id==this._conf.id||target.id==this._conf.trigger)||(this._conf.period&&monthPicker.Params.current==monthPicker.Constant.START_MONTH)||target.className&&(target.className=="i_pre"||target.className=="i_next"))&&$("#"+this._conf.container).length>0&&$("#"+this._conf.container).hide()},submit:function(){var result=[];fd=this.util.format(this.assemble);for(var p in fd){result.push(fd[p])}this.util.$(this._conf.container).style.display="none";this._conf.input.innerHTML=result.join("-");this._conf.callback(this.convertToDate(this.util.format(this.assemble)))},reset:function(obj){obj.construct();obj.util.$("gri_nextYear").style.display=(obj.assemble.year>=obj._conf.endYear)?"none":"block";obj.util.$("gri_preYear").style.display=(obj.assemble.year<=obj._conf.startYear)?"none":"block";var c=obj.getCurrentShowDate();if(obj.util.format(obj.assemble).year==c.year&&obj.util.format(obj.assemble).month==c.month){$("#gri_month"+obj.assemble.month).addClass(obj._conf.selectCss)}if(obj._conf.period){obj.periodCss()}},util:{$:function(id){return document.getElementById(id)},creatEle:function(ele){return document.createElement(ele)},addEvt:function(elem,type,hdl){var callback=function(evt){var evt=window.event||evt,target=evt.srcElement||evt.target;hdl(evt,target)};window.addEventListener&&elem.addEventListener(type,callback,false)||window.attachEvent&&elem.attachEvent("on"+type,callback)},getCurrentDate:function(){return{"year":new Date().getFullYear(),"month":new Date().getMonth()+1}},getCla:function(){return !!(window.attachEvent&&navigator.userAgent.indexOf("Opera")===-1)?"class":"class"},format:function(obj){return{"year":obj.year,"month":(obj.month<10?"0":"")+obj.month}}}};monthPicker.Constant={START_MONTH:"start_month",END_MONTH:"end_month"};monthPicker.Params={current:"",start_year:"",start_month:"",end_month:"",end_year:""};